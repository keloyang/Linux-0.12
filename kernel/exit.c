/*
 *  linux/kernel/exit.c
 *
 *  (C) 1991  Linus Torvalds
 */

#define DEBUG_PROC_TREE         				// ?¡§¨°?¡¤?o?"¦Ì¡Â?¨¨??3¨¬¨º¡Â"

#include <errno.h>
#include <signal.h>
#include <sys/wait.h>

#include <linux/sched.h>
#include <linux/kernel.h>
#include <linux/tty.h>
#include <asm/segment.h>

//int sys_pause(void);
//int sys_close(int fd);
extern int sys_close();         				// 6 - 1?¡À????t

// ¨º¨ª¡¤????¡§??3¨¬??¨®?¦Ì?¨¨???2??¡ã??¨¨???¨ºy?Y?¨¢11??¨®?¦Ì??¨²?¨²¨°3???¡ê
// 2?¨ºyp¨º?¨¨???¨ºy?Y?¨¢11?????¡ê??o¡¥¨ºy?¨²o¨®??¦Ì?sys_kill()o¨ªsys_waitpid()o¡¥¨ºy?D¡À?¦Ì¡Â¨®??¡ê¨¦¡§?¨¨¨¨???????¨ºy¡Á¨¦¡À¨ªtask[]
// ¨°??¡ã?¨°???¡§¦Ì?¨¨????¡ê¨¨?1??¨°¦Ì?¡ê??¨°¨º¡Á?¨¨??????¨¨???2?¡ê?¨¨?o¨®¨º¨ª¡¤???¨¨???¨ºy?Y?¨¢11?¨´??¨®?¦Ì??¨²?¨²¨°3??¡ê?¡Á?o¨®?¡äDD¦Ì¡Â?¨¨o¡¥¨ºy2¡é¡¤¦Ì??
// ¨¢¡é?¡ä¨ª?3??¡ê¨¨?1??¨²¨¨???¨ºy¡Á¨¦¡À¨ª?D??¨®D?¨°¦Ì????¡§¨¨?????¨®|¦Ì???¡ê??¨°?¨²o?panic?¡ê
void release(struct task_struct * p)
{
	int i;

	// ¨¨?1????¡§¦Ì?¨¨????¨¢11?????aNULL?¨°¨ª?3??¡ê¨¨?1??????????¨°¦Ì¡À?¡ã??3¨¬?¨°??¨º??¡¥??D??¡é¨ª?3??¡ê
	if (!p)
		return;
	if (p == current) {
		printk("task releasing itself\n\r");
		return;
	}
	// ¨¦¡§?¨¨¨¨????¨¢11????¨ºy¡Á¨¦¡ê??¡ã?¨°???¡§¦Ì?¨¨???p?¡ê¨¨?1??¨°¦Ì?¡ê??¨°????¨¨???????¨ºy¡Á¨¦?D??¨®|??¡ê?2¡é?¨°?¨¹D?¨¨????¨¢11????¦Ì?1?¨¢a????¡ê?¨º¨ª¡¤?
	// ¨¨???p¨ºy?Y?¨¢11??¨®?¦Ì??¨²?¨²¨°3???¡ê¡Á?o¨®?¨²?¡äDD¦Ì¡Â?¨¨3¨¬D¨°¡¤¦Ì??o¨®¨ª?3??¡ê¨¨?1???¨®D?¨°¦Ì????¡§¦Ì?¨¨???p¡ê??¨°?¦Ì?¡Â?¨²o?¡ä¨²??3?¡ä¨ª¨¢?¡ê??¨°??¨º?3?¡ä¨ª
	// D??¡é2¡é?¨¤?¨²?¡ê
	// ?¨¹D?¨¢¡ä?¨®2?¡¤?¦Ì?¡ä¨²???¨¢¡ã????¡§¨¨???p¡ä¨®???¨°¨¢¡ä¡À¨ª?D¨¦?3y?¡ê
	for (i = 1 ; i < NR_TASKS ; i++)
		if (task[i] == p) {
			task[i] = NULL;
			/* Update links */      /* ?¨¹D?¨¢¡ä?¨® */
			// ¨¨?1?p2?¨º?¡Á?o¨®¡ê¡§¡Á?¨¤?¡ê?¦Ì?¡Á¨®??3¨¬¡ê??¨°¨¨?¡À¨¨??¨¤?¦Ì?¡À¨¨¨¢¨²??3¨¬???¨°¡À¨¨?¨¹D?¦Ì?¡À¨¨¨¢¨²??3¨¬?¡ê¨¨?1?p2?¨º?¡Á?D?¦Ì?¡Á¨®??3¨¬¡ê??¨°¨¨?¡À¨¨??D?¦Ì?¡À¨¨¨¢¨²¡Á¨®??3¨¬
			// ???¨°¡À¨¨¨¢¨²¦Ì?¨¤???3¨¬?¡ê¨¨?1?¨¨???p?¨ª¨º?¡Á?D?¦Ì?¡Á¨®??3¨¬¡ê??¨°?1D¨¨¨°a?¨¹D???????3¨¬¦Ì?¡Á?D?¡Á¨®??3¨¬????cptr?a???¨°p¦Ì?¡À¨¨¨¢¨²¡Á¨®??3¨¬?¡ê
			// ????osptr¡ê¡§old sibling pointer¡ê????¨°¡À¨¨p?¨¨¡ä¡ä?¡§¦Ì?D?¦Ì¨¹??3¨¬?¡ê
			// ????ysptr¡ê¡§younger sibling pointer¡ê????¨°¡À¨¨po¨®¡ä¡ä?¡§¦Ì?D?¦Ì¨¹??3¨¬?¡ê
			// ????pptr¡ê¡§parent pointer¡ê????¨°p¦Ì?????3¨¬?¡ê
			// ????cptr¡ê¡§child pointer¡ê?¨º?????3¨¬???¨°¡Á?D?¡ê¡§¡Á?o¨®¡ê?¡ä¡ä?¡§¦Ì?¡Á¨®??3¨¬?¡ê
			if (p->p_osptr)
				p->p_osptr->p_ysptr = p->p_ysptr;
			if (p->p_ysptr)
				p->p_ysptr->p_osptr = p->p_osptr;
			else
				p->p_pptr->p_cptr = p->p_osptr;
			// ¨º¨ª¡¤?¨°a¨º¨ª¡¤?¦Ì???3¨¬¨ºy?Y?¨¢11??¨®?¦Ì???¨°3?¨²¡ä?
			free_page((long)p);
			// ??D?¦Ì¡Â?¨¨??3¨¬
			schedule();
			return;
		}
	panic("trying to release non-existent task");
}

#ifdef DEBUG_PROC_TREE
// ¨¨?1??¡§¨°?¨¢?¡¤?o?DEBUG_PROC_TREE¡ê??¨°¡À¨¤¨°?¨º¡À¡ã¨¹¨¤¡§¨°???¡ä¨²???¡ê
/*
 * Check to see if a task_struct pointer is present in the task[] array
 * Return 0 if found, and 1 if not found.
 */
/*
 * ?¨¬2¨¦task[]¨ºy¡Á¨¦?D¨º?¡¤?¡ä??¨²¨°??????¡§¦Ì?task_struct?¨¢11????p?¡ê
 */
// ?¨¬2a¨¨????¨¢11????p?¡ê
int bad_task_ptr(struct task_struct *p)
{
	int 	i;

	if (!p)
		return 0;
	for (i = 0 ; i < NR_TASKS ; i++)
		if (task[i] == p)
			return 0;
	return 1;
}

/*
 * This routine scans the pid tree and make sure the rep invarient still
 * holds.  Used for debugging only, since it's very slow....
 *
 * It looks a lot scarier than it really is.... we're doing ?nothing more
 * than verifying the doubly-linked list found?in p_ysptr and p_osptr,
 * and checking it corresponds with the process tree defined by p_cptr and
 * p_pptr;
 */
/*
 * ????¦Ì?o¡¥¨ºy¨®?¨®¨²¨¦¡§?¨¨??3¨¬¨º¡Â¡ê?¨°?¨¨¡¤?¡§?¨¹??1y¦Ì?¨¢¡ä?¨®¨¨?¨¨??y¨¨¡¤?¡ê??¨®?¨®¨²¦Ì¡Â¨º?¡ê?¨°¨°?a??o¡¥¨ºy¡À¨¨???y...
 *
 * ??o¡¥¨ºy?¡ä¨¦?¨¨£¤¨°a¡À¨¨¨º¦Ì?¨º¦Ì???2¨¤....??¨º¦Ì?¨°???????¨¦?¡è¨¢?????p_ysptro¨ªp_osptr113¨¦¦Ì????¨°¨¢¡ä¡À¨ª¡ê?2¡é?¨¬2¨¦
 * ¨¢?¨¢¡ä¡À¨ª¨®?????p_cptro¨ªp_pptr113¨¦¦Ì???3¨¬¨º¡Â????¦Ì?1??¦Ì?¡ê
 */
// ?¨¬2¨¦??3¨¬¨º¡Â?¡ê
void audit_ptree()
{
	int	i;

	// ¨¦¡§?¨¨?¦Ì¨ª3?D¦Ì?3y¨¨???0¨°?¨ªa¦Ì??¨´¨®D¨¨???¡ê??¨¬2¨¦?¨¹???D4??????¡ê¡§pptr?¡écptr?¡éysptro¨ªosptr¡ê?¦Ì??y¨¨¡¤D??¡ê¨¨?¨¨???¨ºy¡Á¨¦2?¡ê¡§??¡ê?
	// ?a???¨°¨¬?1y?¡ê
	for (i = 1 ; i < NR_TASKS ; i++) {
		if (!task[i])
			continue;
		// ¨¨?1?¨¨???¦Ì?????3¨¬????p_pptr??¦Ì????¨°¨¨?o???3¨¬¡ê¡§?¡ä?¨²¨¨???¨ºy¡Á¨¦?D¡ä??¨²¡ê?¡ê??¨°??¨º??¡¥??D??¡é?¡ã?¡¥??¡ê?pido?N¦Ì?????3¨¬¨¢¡ä?¨®¨®D?¨º¨¬a?¡À?¡ê
		// ¨°???¨®?????cptr?¡éysptro¨ªosptr??DD¨¤¨¤??2¨´¡Á¡Â?¡ê
		if (bad_task_ptr(task[i]->p_pptr))
			printk("Warning, pid %d's parent link is bad\n",
				task[i]->pid);
		if (bad_task_ptr(task[i]->p_cptr))
			printk("Warning, pid %d's child link is bad\n",
				task[i]->pid);
		if (bad_task_ptr(task[i]->p_ysptr))
			printk("Warning, pid %d's ys link is bad\n",
				task[i]->pid);
		if (bad_task_ptr(task[i]->p_osptr))
			printk("Warning, pid %d's os link is bad\n",
				task[i]->pid);
		// ¨¨?1?¨¨???¦Ì?????3¨¬????p_pptr???¨°¨¢?¡Á??o¡ê??¨°??¨º??¡¥??D??¡é?¡ã?¡¥??¡ê?pido?N¦Ì?????3¨¬¨¢¡ä?¨®???????¨°¨¢?¡Á??o?¡À?¡ê¨°???¨®?????cptr?¡éysptr
		// o¨ªosptr??DD¨¤¨¤??2¨´¡Á¡Â?¡ê
		if (task[i]->p_pptr == task[i])
			printk("Warning, pid %d parent link points to self\n");
		if (task[i]->p_cptr == task[i])
			printk("Warning, pid %d child link points to self\n");
		if (task[i]->p_ysptr == task[i])
			printk("Warning, pid %d ys link points to self\n");
		if (task[i]->p_osptr == task[i])
			printk("Warning, pid %d os link points to self\n");
		// ¨¨?1?¨¨???¨®D¡À¨¨¡Á??o?¨¨¡ä¡ä?¡§¦Ì?¡À¨¨¨¢¨²D?¦Ì¨¹??3¨¬¡ê????¡ä?¨ª?¨¬2¨¦?¨¹??¨º?¡¤?¨®D12¨ª?¦Ì?????3¨¬¡ê?2¡é?¨¬2¨¦?a??¨¤?D?¦Ì¨¹??3¨¬¦Ì?ysptr????¨º?¡¤??y¨¨¡¤¦Ì????¨°¡À?
		// ??3¨¬?¡ê¡¤??¨°??¨º??¡¥??D??¡é?¡ê
		if (task[i]->p_osptr) {
			if (task[i]->p_pptr != task[i]->p_osptr->p_pptr)
				printk(
			"Warning, pid %d older sibling %d parent is %d\n",
				task[i]->pid, task[i]->p_osptr->pid,
				task[i]->p_osptr->p_pptr->pid);
			if (task[i]->p_osptr->p_ysptr != task[i])
				printk(
		"Warning, pid %d older sibling %d has mismatched ys link\n",
				task[i]->pid, task[i]->p_osptr->pid);
		}
		// ¨¨?1?¨¨???¨®D¡À¨¨¡Á??oo¨®¡ä¡ä?¡§¦Ì?¡À¨¨¨¢¨²D?¦Ì¨¹??3¨¬¡ê????¡ä?¨ª?¨¬2¨¦?¨¹??¨º?¡¤?¨®D12¨ª?¦Ì?????3¨¬¡ê?2¡é?¨¬2¨¦?a??D?¦Ì¨¹??3¨¬¦Ì?osptr????¨º?¡¤??y¨¨¡¤¦Ì????¨°¡À???3¨¬
		// ¡¤??¨°??¨º??¡¥??D??¡é?¡ê
		if (task[i]->p_ysptr) {
			if (task[i]->p_pptr != task[i]->p_ysptr->p_pptr)
				printk(
			"Warning, pid %d younger sibling %d parent is %d\n",
				task[i]->pid, task[i]->p_osptr->pid,
				task[i]->p_osptr->p_pptr->pid);
			if (task[i]->p_ysptr->p_osptr != task[i])
				printk(
		"Warning, pid %d younger sibling %d has mismatched os link\n",
				task[i]->pid, task[i]->p_ysptr->pid);
		}
		// ¨¨?1?¨¨???¦Ì?¡Á?D?¡Á¨®??3¨¬????cptr2???¡ê????¡ä?¨¬2¨¦??¡Á¨®??3¨¬¦Ì?????3¨¬¨º?¡¤??a¡À???3¨¬¡ê?2¡é?¨¬2¨¦??¡Á¨®??3¨¬¦Ì?D?¦Ì¨¹??3¨¬????yspter¨º?¡¤??a???¡ê¨¨?2?¨º?
		// ?¨°??¨º??¡¥??D??¡é?¡ê
		if (task[i]->p_cptr) {
			if (task[i]->p_cptr->p_pptr != task[i])
				printk(
			"Warning, pid %d youngest child %d has mismatched parent link\n",
				task[i]->pid, task[i]->p_cptr->pid);
			if (task[i]->p_cptr->p_ysptr)
				printk(
			"Warning, pid %d youngest child %d has non-NULL ys link\n",
				task[i]->pid, task[i]->p_cptr->pid);
		}
	}
}
#endif /* DEBUG_PROC_TREE */

// ?¨°???¡§¨¨???p¡¤¡é?¨ªD?o?sig¡ê?¨¨¡§?T?apriv?¡ê
// 2?¨ºy¡êosig - D?o??¦Ì¡ê?p - ???¡§¨¨???¦Ì?????¡ê?priv - ????¡¤¡é?¨ªD?o?¦Ì?¡À¨º???¡ê?¡ä2?D¨¨¨°a??????3¨¬¨®??¡ì¨º?D??¨°??¡Àe???¨¹¡¤¡é
// ?¨ªD?o?sig2¡é¨ª?3?¡ê?¡¤??¨°¡¤¦Ì???¡äD¨ª?¨¦¡ä¨ª?¨®o??¡ê
static inline int send_sig(long sig, struct task_struct * p, int priv)
{
	// ¨¨?1???¨®D¨¨¡§?T¡ê?2¡é?¨°¦Ì¡À?¡ã??3¨¬¦Ì?¨®DD¡ì¨®??¡ìID¨®???3¨¬p¦Ì?2?¨ª?¡ê?2¡é?¨°¨°22?¨º?3???¨®??¡ì¡ê??¨°?¦Ì?¡Â??¨®D?¨°p¡¤¡é?¨ªD?o?¦Ì?¨¨¡§¨¤??¡êsuser()
	// ?¡§¨°??a¡ê¡§current->euid==0¡ê?¡ê?¨®?¨®¨²?D??¨º?¡¤??a3???¨®??¡ì?¡ê
	if (!p)
		return -EINVAL;
	if (!priv && (current->euid != p->euid) && !suser())
		return -EPERM;
	// ¨¨?D¨¨¨°a¡¤¡é?¨ª¦Ì?D?o?¨º?SIGKILL?¨°SIGCONT¡ê????¡ä¨¨?1?¡ä?¨º¡À?¨®¨º?D?o?¦Ì???3¨¬p?y¡ä|¨®¨²¨ª¡ê?1¡Á¡ä¨¬??¨ª?????a?¨ªD¡Â¡ê¡§??DD¡ê?¡Á¡ä¨¬??¡ê¨¨?o¨®
	// DT????3¨¬p¦Ì?D?o???¨ª?signal¡ê?¨¨£¤¦Ì?¡ê¡§?¡ä??¡ê??¨¢¦Ì?????3¨¬¨ª¡ê?1¦Ì?D?o?SIGSTOP?¡éSIGTSTP?¡éSIGTTINo¨ªSIGTTOU?¡ê
	if ((sig == SIGKILL) || (sig == SIGCONT)) {
		if (p->state == TASK_STOPPED)
			p->state = TASK_RUNNING;
		p->exit_code = 0;
		p->signal &= ~( (1 << (SIGSTOP - 1)) | (1 << (SIGTSTP - 1)) |
				(1 << (SIGTTIN - 1)) | (1 << (SIGTTOU - 1)) );
	}
	/* If the signal will be ignored, don't even post it */
    /* ¨¨?1?¨°a¡¤¡é?¨ª¦Ì?D?o?sig??¡À???3¨¬po???¦Ì?¡ê????¡ä?¨ª?¨´¡À?2?¨®?¡¤¡é?¨ª */
	if ((int) p->sigaction[sig - 1].sa_handler == 1)
		return 0;
	/* Depends on order SIGSTOP, SIGTSTP, SIGTTIN, SIGTTOU */
   	/* ¨°????D??¨°¨¤¨¤¦Ì¨®¨²SIGSTOP?¡éSIGTSTP?¡éSIGTTINo¨ªSIGTTOU */
	// ¨¨?1?D?o?¨º?SIGSTOP?¡éSIGTSTP?¡éSIGTTINo¨ªSIGTTOU??¨°?¡ê????¡ä?¦Ì?¡Â¨°a¨¨??¨®¨º?D?o?¦Ì???3¨¬p¨ª¡ê?1??DD?¡ê¨°¨°¡ä?¡ê¡§¨¨?p¦Ì?D?o???¨ª?
	// ?D¨®DSIGCONT????¡ê??¨ªD¨¨¨°a?¡ä????¨ª??D?¨¬D???DD¦Ì?D?o??¡ê
	if ((sig >= SIGSTOP) && (sig <= SIGTTOU))
		p->signal &= ~(1 << (SIGCONT - 1));
	/* Actually deliver the signal */
    /* ¡Á?o¨®¡ê??¨°???¨°??3¨¬p¡¤¡é?¨ªD?o?p */
	p->signal |= (1 << (sig - 1));
	return 0;
}

// ?¨´?Y??3¨¬¡Á¨¦o?pgrp¨¨?¦Ì???3¨¬¡Á¨¦?¨´¨º?¦Ì??¨¢?¡ão??¡ê
// ¨¦¡§?¨¨¨¨???¨ºy¡Á¨¦¡ê??¡ã?¨°??3¨¬¡Á¨¦o??apgrp¦Ì???3¨¬¡ê?2¡é¡¤¦Ì?????¨¢?¡ão??¡ê¨¨?1???¨®D?¨°¦Ì????¡§¦Ì???3¨¬¡Á¨¦o?pgrp¦Ì?¨¨?o???3¨¬¡ê??¨°¡¤¦Ì??-1.
int session_of_pgrp(int pgrp)
{
	struct task_struct **p;

 	for (p = &LAST_TASK ; p > &FIRST_TASK ; --p)
		if ((*p)->pgrp == pgrp)
			return((*p)->session);
	return -1;
}

// ???1??3¨¬¡Á¨¦¡ê¡§?¨°??3¨¬¡Á¨¦¡¤¡é?¨ªD?o?¡ê??¡ê
// 2?¨ºy¡êopgrp - ???¡§¦Ì???3¨¬¡Á¨¦o?¡ê?sig - ???¡§¦Ì?D?o?¡ê?priv - ¨¨¡§?T?¡ê
// ?¡ä?¨°???¡§??3¨¬¡Á¨¦pgrp?D¦Ì???????3¨¬¡¤¡é?¨ª???¡§D?o?sig?¡ê??¨°a?¨°¨°?????3¨¬¡¤¡é?¨ª3¨¦1|¡Á?o¨®?¨ª?¨¢¡¤¦Ì??0¡ê?¡¤??¨°¨¨?1???¨®D?¨°¦Ì????¡§??3¨¬
// ¡Á¨¦o?pgrp¦Ì?¨¨?o?¨°?????3¨¬¡ê??¨°¡¤¦Ì??3?¡ä¨ªo?-ESRCH¡ê?¨¨??¨°¦Ì???3¨¬¡Á¨¦o?¨º?pgrp¦Ì???3¨¬¡ê?¦Ì?¨º?¡¤¡é?¨ªD?o?¨º¡ì¡ã¨¹¡ê??¨°¡¤¦Ì??¡¤¡é?¨ª¨º¡ì¡ã¨¹¦Ì?
// ¡ä¨ª?¨®???¡ê
int kill_pg(int pgrp, int sig, int priv)
{
	struct task_struct **p;
	int err,retval = -ESRCH;                // -ESRCH¡À¨ª¨º????¡§¦Ì???3¨¬2?¡ä??¨²?¡ê
	int found = 0;

	// ¨º¡Á?¨¨?D?????¡§¦Ì?D?o?o¨ª??3¨¬¡Á¨¦o?¨º?¡¤?¨®DD¡ì?¡ê¨¨?o¨®¨¦¡§?¨¨?¦Ì¨ª3?D?¨´¨®D¨¨????¡ê¨¨?¨¦¡§?¨¨¦Ì???3¨¬¡Á¨¦o??apgrp¦Ì???3¨¬¡ê??¨ª?¨°??¡¤¡é?¨ªD?o?sig?¡ê
	// ??¨°a¨®D¨°?¡ä?D?o?¡¤¡é?¨ª3¨¦1|¡ê?o¡¥¨ºy¡Á?o¨®?¨ª?¨¢¡¤¦Ì??0?¡ê
	if (sig < 1 || sig > 32 || pgrp <= 0)
		return -EINVAL;
 	for (p = &LAST_TASK ; p > &FIRST_TASK ; --p)
		if ((*p)->pgrp == pgrp) {
			if (sig && (err = send_sig(sig, *p, priv)))
				retval = err;
			else
				found++;
		}
	return(found ? 0 : retval);
}

// ???1??3¨¬¡ê¡§?¨°??3¨¬¡¤¡é?¨ªD?o?¡ê??¡ê
// 2?¨ºy¡êopid - ??3¨¬o?¡ê?sig - ???¡§D?o?¡ê?priv - ¨¨¡§?T?¡ê
// ?¡ä?¨°??3¨¬o??apid¦Ì???3¨¬¡¤¡é?¨ª???¡§D?o?sig?¡ê¨¨??¨°¦Ì????¡§pid¦Ì???3¨¬¡ê????¡ä¨¨?D?o?¡¤¡é?¨ª3¨¦1|¡ê??¨°¡¤¦Ì??0¡ê?¡¤??¨°¡¤¦Ì??D?o?¡¤¡é?¨ª3?¡ä¨ª?¡ê
// ¨¨?1???¨®D?¨°¦Ì????¡§??3¨¬o?pid¦Ì???3¨¬¡ê??¨°¡¤¦Ì??3?¡ä¨ªo?-ESRCH¡ê¡§???¡§??3¨¬2?¡ä??¨²¡ê??¡ê
int kill_proc(int pid, int sig, int priv)
{
 	struct task_struct **p;

	if (sig < 1 || sig > 32)
		return -EINVAL;
	for (p = &LAST_TASK ; p > &FIRST_TASK ; --p)
		if ((*p)->pid == pid)
			return(sig ? send_sig(sig, *p, priv) : 0);
	return(-ESRCH);
}

/*
 * POSIX specifies that kill(-1,sig) is unspecified, but what we have
 * is probably wrong.  Should make it like BSD or SYSV.
 */
/*
 * POSIX¡À¨º¡Á????¡Âkill(-1,sig)?¡ä?¡§¨°??¡ê¦Ì?¨º??¨°?¨´?a¦Ì¨¤¦Ì??¨¦?¨¹¡ä¨ª¨¢??¡ê¨®|??¨¨??¨¹??BSD?¨°SYSV?¦Ì¨ª3¨°??¨´?¡ê
 */
// ?¦Ì¨ª3¦Ì¡Â¨®?kill()?¨¦¨®?¨®¨²?¨°¨¨?o???3¨¬?¨°??3¨¬¡Á¨¦¡¤¡é?¨ª¨¨?o?D?o?¡ê???2¡é¡¤???¨º?¨¦¡À?¨¤??3¨¬?¡ê
// 2?¨ºypid¨º???3¨¬o?¡ê?sig¨º?D¨¨¨°a¡¤¡é?¨ª¦Ì?D?o??¡ê
// ¨¨?1?pid?¦Ì>0¡ê??¨°D?o?¡À?¡¤¡é?¨ª????3¨¬o?¨º?pid¦Ì???3¨¬?¡ê
// ¨¨?1?pid=0¡ê????¡äD?o??¨ª?¨¢¡À?¡¤¡é?¨ª??¦Ì¡À?¡ã??3¨¬¦Ì???3¨¬¡Á¨¦?D?¨´¨®D¦Ì???3¨¬?¡ê
// ¨¨?1?pid=-1¡ê??¨°D?o?sig?¨ª?¨¢¡¤¡é?¨ª??3y¦Ì¨²¨°?????3¨¬¡ê¡§3?¨º???3¨¬¡ê?¨ªa¦Ì??¨´¨®D??3¨¬?¡ê
// ¨¨?1?pid<-1¡ê??¨°D?o?sig??¡¤¡é?¨ª????3¨¬¡Á¨¦-pid¦Ì??¨´¨®D??3¨¬?¡ê
// ¨¨?1?D?o?sig?a0¡ê??¨°2?¡¤¡é?¨ªD?o?¡ê?¦Ì?¨¨??¨¢??DD¡ä¨ª?¨®?¨¬2¨¦?¡ê¨¨?1?3¨¦1|?¨°¡¤¦Ì??0.
// ??o¡¥¨ºy¨¦¡§?¨¨¨¨???¨ºy¡Á¨¦¡À¨ª¡ê?2¡é?¨´?Ypid???¨²¡Á?¨¬??t¦Ì???3¨¬¡¤¡é?¨ª???¡§D?o?sig?¡ê¨¨?pid¦Ì¨¨¨®¨²0¡ê?¡À¨ª?¡Â¦Ì¡À?¡ã??3¨¬¨º???3¨¬¡Á¨¦¡Á¨¦3¡è¡ê?¨°¨°¡ä?D¨¨¨°a
// ?¨°?¨´¨®D¡Á¨¦?¨²¦Ì???3¨¬????¡¤¡é?¨ªD?o?sig?¡ê
int sys_kill(int pid, int sig)
{
	struct task_struct **p = NR_TASKS + task;       // p???¨°¨¨???¨ºy¡Á¨¦¡Á?o¨®¨°????¡ê
	int err, retval = 0;

	if (!pid)
		return(kill_pg(current->pid, sig, 0));
	if (pid == -1) {
		while (--p > &FIRST_TASK)
			if (err = send_sig(sig, *p, 0))
				retval = err;
		return(retval);
	}
	if (pid < 0)
		return(kill_pg(-pid, sig, 0));
	/* Normal kill */
	return(kill_proc(pid, sig, 0));
}

/*
 * Determine if a process group is "orphaned", according to the POSIX
 * definition in 2.2.2.52.  Orphaned process groups are not to be affected
 * by terminal-generated stop signals.  Newly orphaned process groups are
 * to receive a SIGHUP and a SIGCONT.
 *
 * "I ask you, have you ever known what it is to be an orphan?"
 */
/*
 * ?¨´?YPOSIX¡À¨º¡Á?2.2.2.52?¨²?D¦Ì??¡§¨°?¡ê?¨¨¡¤?¡§¨°?????3¨¬¡Á¨¦¨º?¡¤??a?¡ã1??¨´?¡À?¡ê1??¨´??3¨¬¡Á¨¦2??¨¢¨º¨¹¦Ì?????2¨²¨¦¨²¦Ì?¨ª¡ê?1o?¦Ì?¨®¡ã?¨¬?¡êD?
 * ?¨¹2¨²¨¦¨²¦Ì?1??¨´??3¨¬¡Á¨¦???¨¢¨º?¦Ì?¨°???SIGHUPD?o?o¨ª¨°???SIGCONTD?o??¡ê
 *
 * ?¡ã?¨°?¨º??¡ê???¨º?¡¤????y?a¦Ì¨¤¡Á¡Â?a¨°???1??¨´¨°a??¡Á?¨º2?¡ä¡ê??¡À
 */
// ¨°?¨¦?¨¬¨¢¦Ì?¦Ì?POSIX P1003.1 2.2.2.52?¨²¨º?1?¨®¨²1??¨´??3¨¬¡Á¨¦¦Ì??¨¨¨º??¡ê?¨²¨¢????¨¦????¦Ì¡À¨°?????3¨¬???1¨º¡À?¨¦?¨¹¦Ì?????3¨¬¡Á¨¦¡À?3¨¦
// ?¡ã1??¨´?¡À?¡ê¨°?????3¨¬¡Á¨¦¦Ì???¡Á¨¦¨ªa¦Ì?????3¨¬????¦Ì?¨¢a?¦Ì¨°¨¤¨¤¦Ì¨®¨²??????3¨¬o¨ª??¡Á¨®??3¨¬¨¢????¡ê¨°¨°¡ä?¡ê?¨¨?¡Á¨¦¨ªa¡Á?o¨®¨°???¨¢??¨®????3¨¬¦Ì???3¨¬
// ?¨°¡Á?o¨®¨°???????3¨¬¦Ì??¡À?¨®o¨®¨°¨¢???1¦Ì??¡ã¡ê????¡ä?a????3¨¬¡Á¨¦?¨ª?¨¢3¨¦?a¨°???1??¨´??3¨¬¡Á¨¦?¡ê?¨²¨¨?o?¨°????¨¦????¡ê?¨¨?1???3¨¬¦Ì????1¦Ì???
// ??3¨¬¡Á¨¦¡À?3¨¦1??¨´??3¨¬¡Á¨¦¡ê????¡ä??3¨¬¡Á¨¦?D¦Ì??¨´¨®D??3¨¬?¨ª?¨¢¨®??¨¹??¦Ì?¡Á¡Â¨°¦Ì????shell???a¨¢a?¦Ì?¡ê
// ¡Á¡Â¨°¦Ì????shell??2??¨´??¨®D????3¨¬¡Á¨¦¡ä??¨²¦Ì?¨¨?o?D??¡é?¡ê??????3¨¬¡Á¨¦?D¡ä|¨®¨²¨ª¡ê?1¡Á¡ä¨¬?¦Ì???3¨¬???¨¢¨®¨¤????¨º¡ì?¡ê?a¨¢??a???a???¨º¨¬a¡ê?o?¨®D
// ¨ª¡ê?1¡Á¡ä¨¬???3¨¬¦Ì?D??¨¹2¨²¨¦¨²¦Ì?1??¨´??3¨¬¡Á¨¦?¨ªD¨¨¨°a?¨®¨º???¦Ì?¨°???SIGHUPD?o?o¨ª¨°???SIGCONTD?o?¡ê?¨®?¨®¨²??¨º??¨¹??¨°??-¡ä¨®?¨¹??¦Ì??¨¢?¡ã
// ¡ê¡§session¡ê??D???a¨¢a?¦Ì?¡ê
// SIGHUPD?o???¦Ì?????3¨¬¡Á¨¦?D3¨¦?¡À¡À????1¡ê?3y¡¤??¨¹??2????¨°o???¨¢?SIGHUPD?o??¡ê??SIGCONTD?o???¨º1??D???¨®D¡À?SIGHUPD?o?
// ???1¦Ì???3¨¬?¨¬D???DD?¡ê¦Ì??¨²¡ä¨®?¨¤¨ºy?¨¦????¡ê?¨¨?1?¡Á¨¦?D¨®D¨°?????3¨¬¡ä|¨®¨²¨ª¡ê?1¡Á¡ä¨¬?¡ê????¡ä¡Á¨¦?D?¨´¨®D¦Ì???3¨¬?¨¦?¨¹??¡ä|¨®¨²¨ª¡ê?1¡Á¡ä¨¬??¡ê
//
// ?D??¨°?????3¨¬¡Á¨¦¨º?¡¤??a1??¨´??3¨¬?¡ê¨¨?1?2?¨º??¨°¡¤¦Ì??0¡ê?¨¨?1?¨º??¨°¡¤¦Ì??1.
// ¨¦¡§?¨¨¨¨???¨ºy¡Á¨¦?¡ê¨¨?1?¨¨???????¡ê??¨°????3¨¬¦Ì?¡Á¨¦o?¨®????¡§¦Ì?2?¨ª?¡ê??¨°????3¨¬¨°??-¡ä|¨®¨²???¨¤¡Á¡ä¨¬??¡ê?¨°????3¨¬¦Ì?????3¨¬¨º?init??3¨¬¡ê?
// ?¨°?¦Ì?¡Â¨¦¡§?¨¨¦Ì???3¨¬2?¨º????¡§??3¨¬¡Á¨¦¦Ì?3¨¦?¡À¡ê??¨°??2??¨²¡Á?¨°a?¨®¡ê?¨®¨²¨º?¨¬?1y?¡ê¡¤??¨°?¦Ì?¡Â????3¨¬¨º????¡§¡Á¨¦¦Ì?3¨¦?¡À2¡é?¨°??????3¨¬2?¨º?init
// ??3¨¬?¡ê¡ä?¨º¡À¨¨?1?????3¨¬????3¨¬¦Ì?¡Á¨¦o?2?¦Ì¨¨¨®¨²???¡§¦Ì?¡Á¨¦o?pgrp¡ê?¦Ì?????3¨¬¦Ì??¨¢?¡ão?¦Ì¨¨¨®¨²??3¨¬¦Ì??¨¢?¡ão?¡ê??¨°?¦Ì?¡Â?¨¹??¨ª?¨º?¨®¨²¨°????¨¢?¡ã?¡ê
// ¨°¨°¡ä????¡§¦Ì?pgrp??3¨¬¡Á¨¦???¡§2?¨º?1??¨´??3¨¬¡Á¨¦?¡ê¡¤??¨°......
int is_orphaned_pgrp(int pgrp)
{
	struct task_struct **p;

	for (p = &LAST_TASK ; p > &FIRST_TASK ; --p) {
		if (!(*p) ||
		    ((*p)->pgrp != pgrp) ||
		    ((*p)->state == TASK_ZOMBIE) ||
		    ((*p)->p_pptr->pid == 1))
			continue;
		if (((*p)->p_pptr->pgrp != pgrp) &&
		    ((*p)->p_pptr->session == (*p)->session))
			return 0;
	}
	return(1);	/* (sighing) "Often!" */        /* (¡ã|¡ê?¨º?1??¨´??3¨¬¡Á¨¦¡ê? */
}

// ?D????3¨¬¡Á¨¦?D¨º?¡¤?o?¨®D¡ä|¨®¨²¨ª¡ê?1¡Á¡ä¨¬?¦Ì?¡Á¡Â¨°¦Ì¡ê¡§??3¨¬¡Á¨¦¡ê??¡ê¨®D?¨°¡¤¦Ì??1¡ê??T?¨°¡¤¦Ì??0.
// 2¨¦?¨°¡¤?¡¤¡§¨º?¨¦¡§?¨¨????¨¨???¨ºy¡Á¨¦?¡ê?¨¬2¨¦¨º?¨®¨²???¡§¡Á¨¦pgrp¦Ì?¨¨?o???3¨¬¨º?¡¤?¡ä|¨®¨²¨ª¡ê?1¡Á¡ä¨¬??¡ê
static int has_stopped_jobs(int pgrp)
{
	struct task_struct ** p;

	for (p = &LAST_TASK ; p > &FIRST_TASK ; --p) {
		if ((*p)->pgrp != pgrp)
			continue;
		if ((*p)->state == TASK_STOPPED)
			return(1);
	}
	return(0);
}

// 3¨¬D¨°¨ª?3?¡ä|¨¤¨ªo¡¥¨ºy?¡ê
// ??o¡¥¨ºy???¨´?Y??3¨¬¡Á?¨¦¨ª¦Ì?¨¬?D???????DD¡ä|¨¤¨ª¡ê?2¡é¡ã?¦Ì¡À?¡ã??3¨¬¡Á¡ä¨¬?¨¦¨¨??3¨¦???¨¤¡Á¡ä¨¬?TASK_ZOMBIE¡ê?¡Á?o¨®¦Ì¡Â¨®?¦Ì¡Â?¨¨o¡¥¨ºyschedule()¨¨£¤
// ?¡äDD??????3¨¬¡ê?2??¨´¡¤¦Ì???¡ê
void do_exit(long code)
{
	struct task_struct *p;
	int i;

	// ¨º¡Á?¨¨¨º¨ª¡¤?¦Ì¡À?¡ã??3¨¬¡ä¨²????o¨ª¨ºy?Y???¨´??¦Ì??¨²¡ä?¨°3?¡êo¡¥¨ºyfree_page_tables()¦Ì?¦Ì¨²1??2?¨ºy¡ê¡§get_base()¡¤¦Ì???¦Ì¡ê????¡Â?¨²CPU??D?
	// ¦Ì??¡¤?????D?e¨º???¦Ì??¡¤¡ê?¦Ì¨²2??¡ê¡§get_limit()¡¤¦Ì???¦Ì¡ê??¦Ì?¡Â¨®?¨º¨ª¡¤?¦Ì?¡Á??¨²3¡è?¨¨?¦Ì?¡êget_base()o¨º?D¦Ì?current->ldt[1]??3???3¨¬
	// ¡ä¨²?????¨¨¨º?¡¤?¦Ì?????¡ê¡§current->ldt[2]??3???3¨¬¨ºy?Y???¨¨¨º?¡¤?¦Ì?????¡ê?¡ê?get_limit()?D¦Ì?0x0f¨º???3¨¬¡ä¨²????¦Ì?????¡¤?¡ê¡§0x17¨º?
	// ??3¨¬¨ºy?Y??¦Ì?????¡¤?¡ê??¡ê?¡ä?¨²¨¨?????¦Ì??¡¤¨º¡À¨º1¨®?????¦Ì??¨¨¨º?¡¤??¨´¡ä|¦Ì??¡¤¡Á¡Â?a2?¨ºy¡ê?¨¨???3¡è?¨¨¨º¡À¨º1¨®?????¦Ì?????¡¤?¡Á¡Â?a2?¨ºy?¡ê
	// free_page_tables()o¡¥¨ºy??¨®¨²mm/memory.c???t¡ê?get_base()o¨ªget_limit()o¨º??¨®¨²include/linux/sched.h¨ª¡¤???t?¡ê
	free_page_tables(get_base(current->ldt[1]), get_limit(0x0f));
	free_page_tables(get_base(current->ldt[2]), get_limit(0x17));
	// ¨¨?o¨®1?¡À?¦Ì¡À?¡ã??3¨¬¡ä¨°?a¡Á?¦Ì??¨´¨®D???t?¡ê?¨´??¦Ì¡À?¡ã??3¨¬¦Ì?1¡è¡Á¡Â????pwd?¡é?¨´????root?¡é?¡äDD3¨¬D¨°???t¦Ì?i?¨²¦Ì?¨°??¡ã?a???t??DD¨ª?2?2¨´¡Á¡Â¡ê?
	// ¡¤????¡Â??i?¨²¦Ì?2¡é¡¤?¡Àe????¡ê¡§¨º¨ª¡¤?¡ê??¡ê?¨®¡Á?¡ã?¦Ì¡À?¡ã??3¨¬¦Ì?¡Á¡ä¨¬?¨¦¨¨???a???¨¤¡Á¡ä¨¬?¡ê¡§TASK_ZOMBIE¡ê?¡ê?2¡é¨¦¨¨????3¨¬¨ª?3????¡ê
	for (i = 0 ; i < NR_OPEN ; i++)
		if (current->filp[i])
			sys_close(i);
	//Log(LOG_INFO_TYPE, "<<<<< sys_exit process pid = %d, exit_code = %d >>>>>\n", current->pid, code);
	iput(current->pwd);
	current->pwd = NULL;
	iput(current->root);
	current->root = NULL;
	iput(current->executable);
	current->executable = NULL;
	iput(current->library);
	current->library = NULL;
	current->state = TASK_ZOMBIE;
	current->exit_code = code;
	/*
	 * Check to see if any process groups have become orphaned
	 * as a result of our exiting, and if they have any stopped
	 * jobs, send them a SIGUP and then a SIGCONT.  (POSIX 3.2.2.2)
	 *
	 * Case i: Our father is in a different pgrp than we are
	 * and we were the only connection outside, so our pgrp
	 * is about to become orphaned.
 	 */
    /*
     * ?¨¬2¨¦¦Ì¡À?¡ã??3¨¬¦Ì?¨ª?3?¨º?¡¤??¨¢?¨¬3¨¦¨¨?o???3¨¬¡Á¨¦¡À?3¨¦1??¨´??3¨¬¡Á¨¦?¡ê¨¨?1?¨®D¡ê?2¡é?¨°¨®D¡ä|¨®¨²¨ª¡ê?1¡Á¡ä¨¬?¡ê¡§TASK_STOPPED¡ê?
     * ¦Ì?¡Á¨¦?¡À¡ê??¨°?¨°?¨¹??¡¤¡é?¨ª¨°???SIGHUPD?o?o¨ª¨°???SIGCONTD?o??¡ê¡ê¡§POSIX 3.2.2.2?¨²¨°a?¨®¡ê?
     *
     * ?¨¦??1¡êo?¨°??¦Ì?????3¨¬?¨²¨¢¨ª¨ªa¨°???¨®??¨°??2?¨ª?¦Ì???3¨¬¡Á¨¦?D¡ê???¡À???3¨¬¨º??¨°??¨®?¨ªa??¦Ì??¡§¨°?¨¢a?¦Ì?¡ê?¨´¨°??¨°??¦Ì???3¨¬
     * ¡Á¨¦??¡À?3¨¦¨°???1??¨´??3¨¬¡Á¨¦?¡ê
     */
	// POSIX 3.2.2.2¡ê¡§1991¡ã?¡ê?¨º?1?¨®¨²exit()o¡¥¨ºy¦Ì??¦Ì?¡Â?¡ê¨¨?1?????3¨¬?¨´?¨²¦Ì???3¨¬¡Á¨¦¨®?¦Ì¡À?¡ã??3¨¬¦Ì?2?¨ª?¡ê?¦Ì???¡ä|¨®¨²¨ª?¨°????¨¢?¡ã
	// ¡ê¡§session¡ê??D¡ê?2¡é?¨°¦Ì¡À?¡ã??3¨¬?¨´?¨²??3¨¬¡Á¨¦??¨°a¡À?3¨¦1??¨´??3¨¬¨¢?2¡é?¨°¦Ì¡À?¡ã??3¨¬¦Ì???3¨¬¡Á¨¦?Do?¨®D¡ä|¨®¨²¨ª¡ê?1¡Á¡ä¨¬?¦Ì?¡Á¡Â¨°¦Ì¡ê¡§??3¨¬¡ê?¡ê?
	// ???¡ä?¨ª¨°a?¨°?a??¦Ì¡À?¡ã??3¨¬¦Ì???3¨¬¡Á¨¦¡¤¡é?¨ª¨¢???D?o?¡êoSIGHUPo¨ªSIGCONT?¡ê
	if ((current->p_pptr->pgrp != current->pgrp) &&
	    (current->p_pptr->session == current->session) &&
	    is_orphaned_pgrp(current->pgrp) &&
	    has_stopped_jobs(current->pgrp)) {
		kill_pg(current->pgrp,SIGHUP,1);
		kill_pg(current->pgrp,SIGCONT,1);
	}
	/* Let father know we died */           /* ¨ª¡§?a????3¨¬¦Ì¡À?¡ã??3¨¬?????1 */
	current->p_pptr->signal |= (1 << (SIGCHLD - 1));

	/*
	 * This loop does two things:
	 *
  	 * A.  Make init inherit all the child processes
	 * B.  Check to see if any process groups have become orphaned
	 *	as a result of our exiting, and if they have any stopped
	 *	jons, send them a SIGUP and then a SIGCONT.  (POSIX 3.2.2.2)
	 */
    /*
     * ????¦Ì??-?¡¤¡Á?¨¢?¨¢??t¨º??¨¦¡êo
     *
     * A. ¨¨?init??3¨¬?¨¬3D¦Ì¡À?¡ã??3¨¬?¨´¨®D¡Á¨®3¨¬D¨°?¡ê
     * B. ?¨¬2¨¦¦Ì¡À?¡ã??3¨¬¦Ì?¨ª?3?¨º?¡¤??¨¢?¨¬3¨¦¨¨?o???3¨¬¡Á¨¦¡À?3¨¦1??¨´??3¨¬¡Á¨¦?¡ê¨¨?1?¨®D¡ê?2¡é?¨°¨®D¡ä|¨®¨²¨ª¡ê?1¡Á¡ä¨¬?
     * ¡ê¡§TASK_STOPPED¡ê?¦Ì?¡Á¨¦?¡À¡ê??¨°?¨°?¨¹??¡¤¡é?¨ª¨°???SIGHUPD?o?o¨ª¨°???SIGCONTD?o??¡ê¡ê¡§POSIX 3.2.2.2?¨²¨°a?¨®¡ê?
     */
	// ¨¨?1?¦Ì¡À?¡ã??3¨¬¨®D¡Á¨®??3¨¬¡ê¡§??p_cptr???????¨°¡Á??¨¹¡ä¡ä?¡§¦Ì?¡Á¨®??3¨¬¡ê?¡ê??¨°¨¨???3¨¬1¡ê¡§init??3¨¬¡ê?3¨¦?a???¨´¨®D¡Á¨®??3¨¬¦Ì?????3¨¬?¡ê¨¨?1?
	// ¡Á¨®??3¨¬¨°??-¡ä|¨®¨²???¨¤¡Á¡ä¨¬?¡ê??¨°?¨°init??3¨¬¡ê¡§????3¨¬¡ê?¡¤¡é?¨ª¡Á¨®??3¨¬¨°????1D?o?SIGCHLD?¡ê
	if (p = current->p_cptr) {
		while (1) {
			p->p_pptr = task[1];
			if (p->state == TASK_ZOMBIE)
				task[1]->signal |= (1 << (SIGCHLD - 1));
			/*
			 * process group orphan check
			 * Case ii: Our child is in a different pgrp
			 * than we are, and it was the only connection
			 * outside, so the child pgrp is now orphaned.
			 */
            /*
             * 1??¨´??3¨¬¡Á¨¦?¨¬2a?¡ê
             * ?¨¦??2¡êo?¨°??¦Ì?¡Á¨®??3¨¬?¨²2?¨ª?¦Ì???3¨¬¡Á¨¦?D¡ê???¡À???3¨¬¨º??¨¹???¡§¨°?¨®?¨ªa??¦Ì?¨¢??¨®?¡ê
             * ¨°¨°¡ä????¨²¡Á¨®??3¨¬?¨´¨®D??3¨¬¡Á¨¦??¡À?3¨¦1??¨´??3¨¬¡Á¨¦¨¢??¡ê
             */
			// ¨¨?1?¡Á¨®??3¨¬¨®?¦Ì¡À?¡ã??3¨¬2??¨²¨ª?¨°?????3¨¬¡Á¨¦¦Ì?¨º?¨®¨²¨ª?¨°???session?D¡ê?2¡é?¨°¦Ì¡À?¡ã??3¨¬?¨´?¨²??3¨¬¡Á¨¦??¨°a¡À?3¨¦1??¨´??3¨¬¨¢?¡ê?2¡é?¨°¦Ì¡À?¡ã
			// ??3¨¬¦Ì???3¨¬¡Á¨¦?Do?¨®D¡ä|¨®¨²¨ª¡ê?1¡Á¡ä¨¬?¦Ì?¡Á¡Â¨°¦Ì¡ê¡§??3¨¬¡ê?¡ê????¡ä?¨ª¨°a?¨°?a??¦Ì¡À?¡ã??3¨¬¦Ì???3¨¬¡Á¨¦¡¤¡é?¨ª¨¢???D?o?¡êoSIGHUPo¨ªSIGCONT?¡ê¨¨?1?
			// ??¡Á¨®??3¨¬¨®DD?¦Ì¨¹??3¨¬¡ê??¨°?¨¬D??-?¡¤¡ä|¨¤¨ª?aD?D?¦Ì¨¹??3¨¬?¡ê
			if ((p->pgrp != current->pgrp) &&
			    (p->session == current->session) &&
			    is_orphaned_pgrp(p->pgrp) &&
			    has_stopped_jobs(p->pgrp)) {
				kill_pg(p->pgrp,SIGHUP,1);
				kill_pg(p->pgrp,SIGCONT,1);
			}
			if (p->p_osptr) {
				p = p->p_osptr;
				continue;
			}
			/*
			 * This is it; link everything into init's children
			 * and leave
			 */
            /*
             * ?¨ª?a?¨´¡êo???¨´¨®D¡Á¨®??3¨¬¨¢¡ä?¨®3¨¦?ainit¦Ì?¡Á¨®??3¨¬2¡é¨ª?3??-?¡¤?¡ê
             */
			// ¨ª¡§1y¨¦???¡ä|¨¤¨ª¡ê?¦Ì¡À?¡ã??3¨¬¡Á¨®??3¨¬¦Ì??¨´¨®DD?¦Ì¨¹¡Á¨®??3¨¬??¨°??-¡ä|¨¤¨ª1y?¡ê¡ä?¨º¡Àp???¨°¡Á?¨¤?¦Ì?D?¦Ì¨¹¡Á¨®??3¨¬?¡ê¨®¨²¨º?¡ã??aD?D?¦Ì¨¹¡Á¨®??3¨¬¨¨?2??¨®¨¨?
			// init??3¨¬¦Ì?¡Á¨®??3¨¬???¨°¨¢¡ä¡À¨ª¡À¨ª¨ª¡¤2??D?¡ê?¨®¨¨?o¨®¡ê?init??3¨¬¦Ì?p_cptr???¨°¦Ì¡À?¡ã??3¨¬?-¡Á¨®??3¨¬?D¡Á??¨º?¨¢¦Ì?¡ê¡§the youngest¡ê?¡Á¨®??3¨¬
			// ???-¡Á¨®??3¨¬?D¡Á?¨¤?¦Ì?¡ê¡§the oldest¡ê?D?¦Ì¨¹¡Á¨®??3¨¬p_osptr???¨°?-init??3¨¬¦Ì?¡Á??¨º?¨¢??3¨¬¡ê????-init??3¨¬?D¡Á??¨º?¨¢??3¨¬¦Ì?p_ysptr
			// ???¨°?-¡Á¨®??3¨¬?D¡Á?¨¤?¦Ì?D?¦Ì¨¹¡Á¨®??3¨¬?¡ê¡Á?o¨®¡ã?¦Ì¡À?¡ã??3¨¬¦Ì?p_cptr????????¡ê?2¡é¨ª?3??-?¡¤?¡ê
			p->p_osptr = task[1]->p_cptr;
			task[1]->p_cptr->p_ysptr = p;
			task[1]->p_cptr = current->p_cptr;
			current->p_cptr = 0;
			break;
		}
	}
	// ¨¨?1?¦Ì¡À?¡ã??3¨¬¨º??¨¢?¡ã¨ª¡¤¨¢¨¬¡ê¡§leader¡ê???3¨¬¡ê????¡ä¨¨??¨¹¨®D????????¡ê??¨°¨º¡Á?¨¨?¨°¨º1¨®???????????¦Ì???3¨¬¡Á¨¦¡¤¡é?¨ª1¨°??D?o?SIGHUP¡ê?¨¨?o¨®¨º¨ª¡¤?
	// ???????¡ê?¨®¡Á?¨¦¡§?¨¨¨¨???¨ºy¡Á¨¦¡ê?¡ã?¨º?¨®¨²¦Ì¡À?¡ã??3¨¬?¨¢?¡ã?D??3¨¬¦Ì?????????¡ê¡§¨¨???¡ê??¡ê
	if (current->leader) {
		struct task_struct **p;
		struct tty_struct *tty;

		if (current->tty >= 0) {
			tty = TTY_TABLE(current->tty);
			if (tty->pgrp>0)
				kill_pg(tty->pgrp, SIGHUP, 1);
			tty->pgrp = 0;
			tty->session = 0;
		}
	 	for (p = &LAST_TASK ; p > &FIRST_TASK ; --p)
			if ((*p)->session == current->session)
				(*p)->tty = -1;
	}
	// ¨¨?1?¦Ì¡À?¡ã??3¨¬¨¦?¡ä?¨º1¨®?1yD-¡ä|¨¤¨ª?¡Â¡ê??¨°¡ã?????¡ä?D??¡é¦Ì??????????¡ê¨¨??¡§¨°?¨¢?¦Ì¡Â¨º???3¨¬¨º¡Â¡¤?o?¡ê??¨°¦Ì¡Â¨®???3¨¬¨º¡Â?¨¬2a??¨º?o¡¥¨ºy?¡ê¡Á?o¨®¦Ì¡Â¨®?¦Ì¡Â?¨¨
	// o¡¥¨ºy¡ê???D?¦Ì¡Â?¨¨??3¨¬??DD¡ê?¨°?¨¨?????3¨¬?¨¹1?¡ä|¨¤¨ª???¨¤??3¨¬¦Ì?????¨¦?o¨®¨º?¨°??¡ê
	if (last_task_used_math == current)
		last_task_used_math = NULL;
#ifdef DEBUG_PROC_TREE
	audit_ptree();
#endif
	schedule();
}

// ?¦Ì¨ª3¦Ì¡Â¨®?exit()?¡ê???1??3¨¬?¡ê
// 2?¨ºyerror_code¨º?¨®??¡ì3¨¬D¨°¨¬¨¢1?¦Ì?¨ª?3?¡Á¡ä¨¬?D??¡é¡ê???¨®D¦Ì¨ª¡Á??¨²¨®DD¡ì?¡ê¡ã?error_code¡Á¨®¨°?8??¨º?wait()?¨°waitpid()o¡¥¨ºy¦Ì?¨°a?¨®?¡ê
// ¦Ì¨ª¡Á??¨²?D??¨®?¨¤¡ä¡À¡ê¡ä?wait()¦Ì?¡Á¡ä¨¬?D??¡é?¡ê¨¤y¨¨?¡ê?¨¨?1???3¨¬¡ä|¨®¨²?Y¨ª¡ê¡Á¡ä¨¬?¡ê¡§TASK_STOPPED¡ê?¡ê????¡ä??¦Ì¨ª¡Á??¨²?¨ª¦Ì¨¨¨®¨²0x7f?¡ê2???
// sys/wait.h???t?¡êwait()?¨°waitpid()¨¤?¨®??aD?o¨º?¨ª?¨¦¨°?¨¨?¦Ì?¡Á¨®??3¨¬¦Ì?¨ª?3?¡Á¡ä¨¬????¨°¡Á¨®??3¨¬???1¦Ì??-¨°¨°¡ê¡§D?o?¡ê??¡ê
int sys_exit(int error_code)
{
	do_exit((error_code & 0xff) << 8);
}

// ?¦Ì¨ª3¦Ì¡Â¨®?waitpid()?¡ê1¨°?e¦Ì¡À?¡ã??3¨¬¡ê??¡À¦Ì?pid???¡§¦Ì?¡Á¨®??3¨¬¨ª?3?¡ê¡§???1¡ê??¨°??¨º?¦Ì?¨°a?¨®???1????3¨¬¦Ì?D?o?¡ê??¨°??D?o?¨º?D¨¨¨°a¦Ì¡Â¨®?¨°?
// ??D?o???¡À¨²¡ê¡§D?o?¡ä|¨¤¨ª3¨¬D¨°¡ê??¡ê¨¨?1?pid?¨´??¦Ì?¡Á¨®??3¨¬??¨°?¨ª?3?¡ê¡§¨°?3¨¦?¨´??¦Ì????¨¤??3¨¬¡ê?¡ê??¨°¡À?¦Ì¡Â¨®???¨¢¡é?¨¬¡¤¦Ì???¡ê¡Á¨®??3¨¬¨º1¨®?¦Ì??¨´¨®D
// ¡Á¨º?¡ä??¨º¨ª¡¤??¡ê
// ¨¨?1?pid > 0¡ê?¡À¨ª¨º?¦Ì¨¨¡äy??3¨¬o?¦Ì¨¨¨®¨²pid¦Ì?¡Á¨®??3¨¬?¡ê
// ¨¨?1?pid = 0¡ê?¡À¨ª¨º?¦Ì¨¨¡äy??3¨¬¡Á¨¦o?¦Ì¨¨¨®¨²¦Ì¡À?¡ã??3¨¬¡Á¨¦o?¦Ì?¨¨?o?¡Á¨®??3¨¬?¡ê
// ¨¨?1?pid < -1¡ê?¡À¨ª¨º?¦Ì¨¨¡äy??3¨¬¡Á¨¦o?¦Ì¨¨¨®¨²pid?????¦Ì¦Ì?¨¨???¡Á¨®??3¨¬?¡ê
// ¨¨?1?pid = -1¡ê?¡À¨ª¨º?¦Ì¨¨¡äy¨¨?o?¡Á¨®??3¨¬?¡ê
// ¨¨?options = WUNTRACED¡ê?¡À¨ª¨º?¨¨?1?¡Á¨®??3¨¬¨º?¨ª¡ê?1¦Ì?¡ê?¨°2?¨ª¨¦?¡¤¦Ì??¡ê¡§?TD??¨²¡Á¨´¡ê??¡ê
// ¨¨?options = WNOHANG¡ê?¡À¨ª¨º?¨¨?1???¨®D¡Á¨®??3¨¬¨ª?3??¨°???1?¨ª?¨ª¨¦?¡¤¦Ì???¡ê
// ¨¨?1?¡¤¦Ì??¡Á¡ä¨¬?????stat_addr2??a??¡ê??¨°?¨ª??¡Á¡ä¨¬?D??¡é¡À¡ê¡ä?¦Ì???¨¤??¡ê
// 2?¨ºypid¨º???3¨¬o?¡ê?*stat_addr¨º?¡À¡ê¡ä?¡Á¡ä¨¬?D??¡é????¦Ì?????¡ê?options¨º?waitpid?????¡ê
int sys_waitpid(pid_t pid, unsigned long * stat_addr, int options)
{
	int flag;               				// ??¡À¨º??¨®?¨®¨²o¨®???¨´??3?¦Ì?¡Á¨®??3¨¬¡ä|¨®¨²?¨ªD¡Â?¨°?¡¥??¨¬??¡ê
	struct task_struct *p;
	unsigned long oldblocked;

	// ¨º¡Á?¨¨?¨¦?¡è???¨²¡ä?¡¤?¡Á¡ä¨¬?D??¡é¦Ì?????¡ä|?¨²?¨²????¡Á?1??¡ê¨¨?o¨®?¡ä??¡À¨º??flag?¡ê?¨®¡Á?¡ä¨®¦Ì¡À?¡ã??3¨¬¦Ì?¡Á??¨º?¨¢¡Á¨®??3¨¬?a¨º?¨¦¡§?¨¨¡Á¨®??3¨¬D?¦Ì¨¹¨¢¡ä¡À¨ª?¡ê
	verify_area(stat_addr, 4);
repeat:
	flag = 0;
	for (p = current->p_cptr ; p ; p = p->p_osptr) {
		// ¨¨?1?¦Ì¨¨¡äy¦Ì?¡Á¨®??3¨¬o?pid>0¡ê?¦Ì?¨®?¡À?¨¦¡§?¨¨¡Á¨®??3¨¬p¦Ì?pid2??¨¤¦Ì¨¨¡ê??¦Ì?¡Â?¨¹¨º?¦Ì¡À?¡ã??3¨¬¨¢¨ª¨ªa¦Ì?¡Á¨®??3¨¬¡ê?¨®¨²¨º?¨¬?1y????3¨¬¡ê??¨®¡Á?¨¦¡§?¨¨??¨°?
		// ????3¨¬?¡ê
		if (pid > 0) {
			if (p->pid != pid)
				continue;
		// ¡¤??¨°¡ê?¨¨?1????¡§¦Ì¨¨¡äy??3¨¬¦Ì?pid=0¡ê?¡À¨ª¨º??y?¨²¦Ì¨¨¡äy??3¨¬¡Á¨¦o?¦Ì¨¨¨®¨²¦Ì¡À?¡ã??3¨¬¡Á¨¦o?¦Ì?¨¨?o?¡Á¨®??3¨¬?¡ê¨¨?1?¡ä?¨º¡À¡À?¨¦¡§?¨¨??3¨¬p¦Ì???3¨¬¡Á¨¦o?¨®?¦Ì¡À?¡ã
		// ??3¨¬¦Ì?¡Á¨¦o?2?¦Ì¨¨¡ê??¨°¨¬?1y?¡ê
		} else if (!pid) {
			if (p->pgrp != current->pgrp)
				continue;
		// ¡¤??¨°¡ê?¨¨?1????¡§¦Ì?pid<-1¡ê?¡À¨ª¨º??y?¨²¦Ì¨¨¡äy??3¨¬¡Á¨¦o?¦Ì¨¨¨®¨²pid?????¦Ì¦Ì?¨¨?o?¡Á¨®??3¨¬?¡ê¨¨?1?¡ä?¨º¡À¡À?¨¦¡§?¨¨??3¨¬p¦Ì?¡Á¨¦o?¨®?pid¦Ì??????¦Ì
		// 2?¦Ì¨¨¡ê??¨°¨¬?1y?¡ê
		} else if (pid != -1) {
			if (p->pgrp != -pid)
				continue;
		}
		// ¨¨?1??¡ã3????pid¦Ì??D????2?¡¤?o?¡ê??¨°¡À¨ª¨º?¦Ì¡À?¡ã??3¨¬?y?¨²¦Ì¨¨¡äy??¨¨?o?¡Á¨®??3¨¬¡ê??¡äpid = -1¦Ì??¨¦???¡ê¡ä?¨º¡À?¨´????¦Ì?¦Ì???3¨¬p?¨°??¨º?????3¨¬
		// o?¦Ì¨¨¨®¨²???¡§pid¡ê??¨°??¨º?¦Ì¡À?¡ã??3¨¬¡Á¨¦?D¦Ì?¨¨?o?¡Á¨®??3¨¬¡ê??¨°??¨º???3¨¬o?¡Á¨¦¦Ì¨¨¨®¨²???¡§pid?????¦Ì¦Ì?¡Á¨®??3¨¬¡ê??¨°??¨º?¨¨?o?¡Á¨®??3¨¬¡ê¡§¡ä?¨º¡À???¡§¦Ì?
		// pid¦Ì¨¨¨®¨²-1¡ê??¡ê?¨®??¨¤¡ä?¨´?Y?a??¡Á¨®??3¨¬p?¨´¡ä|¦Ì?¡Á¡ä¨¬?¨¤¡ä¡ä|¨¤¨ª?¡ê
		// ¦Ì¡À¡Á¨®??3¨¬p¨ª¡ê?1¡Á¡ä¨¬?¨º¡À¡ê?¨¨?1?¡ä?¨º¡À2?¨ºy????options?DWUNTRACED¡À¨º????¨®D????¡ê?¡À¨ª¨º?3¨¬D¨°?TD?¨¢¡é?¨¬¡¤¦Ì??¡ê??¨°??¡Á¨®??3¨¬¡ä?¨º¡À¦Ì?¨ª?3???¦Ì¨¨¨®¨²
		// 0¡ê?¨®¨²¨º??¨¬D?¨¦¡§?¨¨¡ä|¨¤¨ª????¡Á¨®??3¨¬?¡ê¨¨?1?WUNTRACED?????¨°¡Á¨®??3¨¬¨ª?3???2??a0,?¨°¡ã?¨ª?3???¨°?¨¨???¡Á??¨²¡ê?¨ª?¡Á¡ä¨¬?D??¡é0x7f??DD?¨°????o¨®
		// ¡¤?¨¨?*stat_addr¡ê??¨²?¡ä??¡Á¨®??3¨¬¨ª?3???o¨®¨¢¡é?¨¬¡¤¦Ì??¡Á¨®??3¨¬o?pid?¡ê?a¨¤?0x7f¡À¨ª¨º?¦Ì?¡¤¦Ì??¡Á¡ä¨¬?¨º1WIFSTOPPED()o¨º?a?¦Ì?¡ê2???include/
		// sys/wait.h?¡ê
		switch (p->state) {
			case TASK_STOPPED:
				if (!(options & WUNTRACED) ||
				    !p->exit_code)
					continue;
				put_fs_long((p->exit_code << 8) | 0x7f,
					stat_addr);
				p->exit_code = 0;
				return p->pid;
			// ¨¨?1?¡Á¨®??3¨¬p¡ä|¨®¨²???¨¤¡Á¡ä¨¬?¡ê??¨°¨º¡Á?¨¨¡ã??¨¹?¨²¨®??¡ì¨¬?o¨ª?¨²o?¨¬???DD¦Ì?¨º¡À??¡¤?¡Àe¨¤???¦Ì?¦Ì¡À?¡ã??3¨¬¡ê¡§????3¨¬¡ê??D¡ê?¨¨?o¨®¨¨?3?¡Á¨®??3¨¬pido¨ª¨ª?3???¡ê?
			// ¡ã?¨ª?3???¡¤?¨¨?¡¤¦Ì??¡Á¡ä¨¬?????stat_addr¡ä|2¡é¨º¨ª¡¤???¡Á¨®??3¨¬?¡ê¡Á?o¨®¡¤¦Ì??¡Á¨®??3¨¬¦Ì?¨ª?3???o¨ªpid?¡ê¨¨??¡§¨°?¨¢?¦Ì¡Â¨º???3¨¬¨º¡Â¡¤?o?¡ê??¨°¦Ì¡Â¨®???3¨¬¨º¡Â
			// ?¨¬2a??¨º?o¡¥¨ºy?¡ê
			case TASK_ZOMBIE:
				current->cutime += p->utime;
				current->cstime += p->stime;
				flag = p->pid;
				//Log(LOG_INFO_TYPE, "<<<<< sys_waitpid current_pid = %d, child_pid = %d, exit_code = %d >>>>>\n", current->pid, p->pid, p->exit_code);
				put_fs_long(p->exit_code, stat_addr);
				release(p);
#ifdef DEBUG_PROC_TREE
				audit_ptree();
#endif
				return flag;
			// ¨¨?1??a??¡Á¨®??3¨¬p¦Ì?¡Á¡ä¨¬??¡ä¨º?2?¨ª¡ê?1¨°22?¨º????¨¤¡ê????¡ä?¨ª??flag = 1?¡ê¡À¨ª¨º??¨°¦Ì?1y¨°???¡¤?o?¨°a?¨®¦Ì?¡Á¨®??3¨¬¡ê?¦Ì?¨º??¨¹¡ä|¨®¨²??DD¨¬??¨°?¡¥??¨¬??¡ê
			default:
				flag = 1;
				continue;
		}
    }
	// ?¨²¨¦?????¨¨???¨ºy¡Á¨¦¨¦¡§?¨¨?¨¢¨º?o¨®¡ê?¨¨?1?flag¡À?????¡ê??¦Ì?¡Â¨¢?¨®D¡¤?o?¦Ì¨¨¡äy¨°a?¨®¦Ì?¡Á¨®??3¨¬2¡é??¨®D¡ä|¨®¨²¨ª?3?¨¢¡é?¨¬?¨°???¨¤¡Á¡ä¨¬??¡ê¡ä?¨º¡À¨¨?1?¨°?¨¦¨¨??
	// WNOHANG????¡ê¡§¡À¨ª¨º?¨¨???¨®D¡Á¨®??3¨¬¡ä|¨®¨²¨ª?3??¨°???1¨¬??¨ª¡¤¦Ì??¡ê?¡ê??¨ª¨¢¡é?¨¬¡¤¦Ì??0,¨ª?3??¡ê¡¤??¨°¡ã?¦Ì¡À?¡ã??3¨¬???a?¨¦?D??¦Ì¨¨¡äy¡Á¡ä¨¬?¡ê?¡À¡ê¨¢?2¡éDT??¦Ì¡À?¡ã
	// ??3¨¬D?o?¡Á¨¨¨¨???¨ª?¡ê??¨ºD¨ª???¨®¨º?SIGCHLDD?o??¡ê¨¨?o¨®?¡äDD¦Ì¡Â?¨¨3¨¬D¨°?¡ê¦Ì¡À?¦Ì¨ª3¨®??a¨º??¡äDD¡À???3¨¬¨º¡À¡ê?¨¨?1?¡À???3¨¬¨º?¦Ì?3ySIGCHLD¨°?¨ªa¦Ì?
	// ?????¡ä?¨¢¡À?D?o?¡ê??¨°¨°?¨ª?3????¡ã??D????¡¥?¦Ì¨ª3¦Ì¡Â¨®??¡À¡¤¦Ì???¡ê¡¤??¨°¨¬?¡Áa¦Ì?o¡¥¨ºy?a¨º?¡ä|repeat¡À¨ºo?¡ä|?????¡ä¡ä|¨¤¨ª?¡ê
	if (flag) {
		if (options & WNOHANG)
			return 0;
		current->state = TASK_INTERRUPTIBLE;
		oldblocked = current->blocked;
		current->blocked &= ~(1 << (SIGCHLD - 1));
		schedule();
		current->blocked = oldblocked;
		if (current->signal & ~(current->blocked | (1 << (SIGCHLD - 1))))
			return -ERESTARTSYS;
		else
			goto repeat;
	}
	// ¨¨?flag = 0¡ê?¡À¨ª¨º???¨®D?¨°¦Ì?¡¤?o?¨°a?¨®¦Ì?¡Á¨®??3¨¬¡ê??¨°¡¤¦Ì??3?¡ä¨ª??¡ê¡§¡Á¨®??3¨¬2?¡ä??¨²¡ê??¡ê
	return -ECHILD;
}



